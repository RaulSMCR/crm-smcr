generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  USER
  ADMIN
  PROFESSIONAL
}

enum PostType {
  TEXT
  VIDEO
  AUDIO
}

enum PostStatus {
  PENDING
  PUBLISHED
  ARCHIVED
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum ProfessionalServiceStatus {
  ACTIVE
  PAUSED
  REMOVED
}

model User {
  id           Int    @id @default(autoincrement())
  email        String @unique
  name         String
  passwordHash String
  role         Role   @default(USER)

  // ✅ Email verification
  emailVerified   Boolean   @default(false)
  verifyTokenHash String?   @db.Text
  verifyTokenExp  DateTime?

  identification String?   @unique
  birthDate      DateTime?
  phone          String?
  gender         String?
  interests      String?   @db.Text
  timeZone       String    @default("UTC")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointments Appointment[]

  @@index([email])
  @@index([emailVerified])
  @@index([verifyTokenExp])
}

model Professional {
  id           Int     @id @default(autoincrement())
  email        String  @unique
  name         String
  profession   String
  passwordHash String
  isApproved   Boolean @default(false)

  // ✅ Email verification (para profesionales también)
  emailVerified   Boolean   @default(false)
  verifyTokenHash String?   @db.Text
  verifyTokenExp  DateTime?

  phone           String?
  bio             String? @db.Text
  avatarUrl       String?
  introVideoUrl   String?
  calendarUrl     String?
  paymentLinkBase String?
  timeZone        String  @default("UTC")

  googleRefreshToken String? @db.Text
  googleCalendarId   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  services     ServicesOnProfessionals[]
  posts        Post[]
  appointments Appointment[]

  @@index([email])
  @@index([profession])
  @@index([isApproved])
  @@index([emailVerified])
  @@index([verifyTokenExp])
}

model Category {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  slug        String  @unique
  description String? @db.Text
  imageUrl    String?

  services Service[]
}

model Service {
  id          Int    @id @default(autoincrement())
  slug        String @unique
  title       String
  description String @db.Text

  price       Decimal @db.Decimal(10, 2)
  durationMin Int     @default(60)

  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  categoryId Int?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  professionals ServicesOnProfessionals[]
  posts         Post[]
  appointments  Appointment[]
}

model ServicesOnProfessionals {
  // ID surrogate para poder referenciar este vínculo desde Appointment
  id Int @id @default(autoincrement())

  professionalId Int
  serviceId      Int

  professional Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  service      Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  createdAt     DateTime                  @default(now())
  status        ProfessionalServiceStatus @default(ACTIVE)
  priceOverride Decimal?                  @db.Decimal(10, 2)
  notes         String?                   @db.Text

  // ✅ Lado opuesto de Appointment.professionalService
  appointments Appointment[] @relation("AppointmentProfessionalService")

  @@unique([professionalId, serviceId])
  @@index([serviceId])
  @@index([professionalId])
  @@index([status])
}

model Post {
  id       Int     @id @default(autoincrement())
  slug     String  @unique
  title    String
  content  String  @db.Text
  imageUrl String?
  mediaUrl String?

  postType PostType   @default(TEXT)
  status   PostStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authorId Int
  author   Professional @relation(fields: [authorId], references: [id], onDelete: Cascade)

  serviceId Int?
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
  @@index([serviceId])
}

model Appointment {
  id        Int      @id @default(autoincrement())
  startTime DateTime
  endTime   DateTime

  status AppointmentStatus @default(CONFIRMED)

  googleEventId String? @unique

  priceFinal   Decimal?  @db.Decimal(10, 2)
  canceledAt   DateTime?
  cancelReason String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  professionalId Int
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  serviceId Int?
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  // vínculo exacto Professional<->Service usado en esa cita
  professionalServiceId Int?
  professionalService   ServicesOnProfessionals? @relation(
    "AppointmentProfessionalService",
    fields: [professionalServiceId],
    references: [id],
    onDelete: SetNull
  )

  @@index([professionalId, startTime])
  @@index([userId, startTime])
  @@index([serviceId])
  @@index([status, startTime])
  @@index([professionalServiceId, startTime])
}
