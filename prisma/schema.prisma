generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // NOTA: Las URLs se movieron a prisma.config.ts por requerimiento de Prisma 7
}

// --- ENUMS ---

enum Role {
  USER
  ADMIN
  PROFESSIONAL
}

enum PostType {
  ARTICLE
  VIDEO
  AUDIO
  TEXT
}

enum PostStatus {
  DRAFT
  PENDING
  PUBLISHED
  ARCHIVED
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED_BY_USER
  CANCELLED_BY_PRO
  COMPLETED
  NO_SHOW
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

// --- MODELOS ---

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  passwordHash  String?   // Opcional si usa Auth Social
  
  // Perfilamiento
  gender        String?
  interests     String?
  phone         String?
  identification String?
  birthDate     DateTime?
  timeZone      String?   @default("UTC")
  
  // Auth & Verificación
  role                 Role      @default(USER)
  emailVerified        Boolean   @default(false)
  
  // Tokens
  verifyTokenHash      String?
  verifyTokenExp       DateTime?
  resetTokenHash       String?
  resetTokenExp        DateTime?

  // Timestamps
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  
  // Relaciones
  appointments         Appointment[]
  approvedProfessionals Professional[] @relation("AdminApprovesPro")
  approvedPosts        Post[]         @relation("AdminApprovesPost")
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  icon        String?
  
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  professionals Professional[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Professional {
  id               String   @id @default(cuid())
  email            String   @unique
  name             String
  slug             String   @unique 
  declaredJobTitle String
  passwordHash     String?   
  
  // Perfil Público
  phone            String?
  avatarUrl        String?
  resumeUrl        String?   
  bio              String?   @db.Text
  introVideoUrl    String?
  
  // Integraciones (Google Calendar y Pagos)
  googleRefreshToken String? 
  googleAccessToken  String?  
  calendarId         String?  @default("primary") 
  paymentLinkBase    String?
  bankAccountInfo    String?

  // Estado Admin
  adminNotes       String?   @db.Text
  isApproved       Boolean   @default(false)
  emailVerified    Boolean   @default(false)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relaciones
  categories       Category[]
  services         Service[]
  posts            Post[]        @relation("ProfessionalToPost")
  availabilities   Availability[]
  appointments     Appointment[]
  
  approvedById     String?
  approvedBy       User?    @relation("AdminApprovesPro", fields: [approvedById], references: [id])
}

model Availability {
  id             String       @id @default(cuid())
  dayOfWeek      Int          // 0=Domingo
  startTime      String       // "09:00"
  endTime        String       // "17:00"
  isActive       Boolean      @default(true)
  
  professionalId String
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@index([professionalId])
}

model Service {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String   @db.Text
  price       Decimal  @default(0.0)
  durationMin Int      @default(60) 
  imageUrl    String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  professionals Professional[]
  posts         Post[]
  appointments  Appointment[] 
}

model Post {
  id          String     @id @default(cuid())
  slug        String     @unique
  title       String
  content     String     @db.Text
  excerpt     String?    @db.Text
  imageUrl    String?
  
  postType    PostType   @default(ARTICLE)
  mediaUrl    String?    
  status      PostStatus @default(PENDING)
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  authorId    String?
  author      Professional? @relation("ProfessionalToPost", fields: [authorId], references: [id])
  
  serviceId   String?
  service     Service?      @relation(fields: [serviceId], references: [id])

  approvedById String?
  approvedBy   User?         @relation("AdminApprovesPost", fields: [approvedById], references: [id])
}

model Appointment {
  id             String            @id @default(cuid())
  date           DateTime          
  endDate        DateTime?         
  
  status         AppointmentStatus @default(PENDING)
  paymentStatus  PaymentStatus     @default(UNPAID)
  
  // Integración Google
  gcalEventId    String?           
  pricePaid      Decimal           @default(0.0)

  userId         String
  user           User              @relation(fields: [userId], references: [id])
  
  professionalId String
  professional   Professional      @relation(fields: [professionalId], references: [id])

  serviceId      String?
  service        Service?          @relation(fields: [serviceId], references: [id])

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
}