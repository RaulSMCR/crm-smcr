// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL") // Descomenta si usas Supabase con pooler
}

// --------------------------------------------------------
// USUARIOS Y ROLES
// --------------------------------------------------------

enum Role {
  USER
  ADMIN
  PROFESSIONAL
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?
  emailVerified DateTime?
  image         String?
  role          Role      @default(USER)
  phone         String?
  
  // Relaciones
  appointments  Appointment[] // Citas como paciente
  accounts      Account[]
  sessions      Session[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Professional {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  slug          String    @unique
  specialty     String
  
  // --- Perfil Completo ---
  phone         String?
  bio           String?
  coverLetter   String?
  cvUrl         String?
  introVideoUrl String?
  
  // --- Seguridad y Verificación ---
  isApproved            Boolean   @default(false)
  emailVerified         Boolean   @default(false)
  verifyTokenHash       String?
  verifyTokenExp        DateTime?
  verifyEmailLastSentAt DateTime?
  
  // --- Timestamps ---
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // --- Relaciones ---
  services      Service[]
  appointments  Appointment[]
  posts         Post[]
  availability  Availability[]  // <--- ¡ESTA ES LA LÍNEA QUE FALTABA!
}

// --------------------------------------------------------
// NEGOCIO: CITAS Y SERVICIOS
// --------------------------------------------------------

model Service {
  id            String   @id @default(cuid())
  title         String
  description   String?  @db.Text
  price         Decimal  @db.Decimal(10, 2)
  durationMin   Int      // Duración en minutos (ej: 50)
  
  // Relaciones
  professionals Professional[] // Muchos profesionales pueden dar este servicio
  appointments  Appointment[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum AppointmentStatus {
  PENDING           // Solicitada
  CONFIRMED         // Aceptada por profesional
  CANCELLED_BY_USER
  CANCELLED_BY_PRO
  COMPLETED         // Terminada
  NO_SHOW           // Paciente no se presentó
}

model Appointment {
  id             String            @id @default(cuid())
  date           DateTime          // Fecha y hora de inicio
  endDate        DateTime          // Fecha y hora de fin (calculada por durationMin)
  status         AppointmentStatus @default(PENDING)
  
  pricePaid      Decimal?          @db.Decimal(10, 2)
  paymentStatus  String?           @default("UNPAID") // UNPAID, PAID, REFUNDED
  gcalEventId    String?           // ID del evento en Google Calendar para borrarlo luego
  
  // Relaciones
  userId         String
  user           User              @relation(fields: [userId], references: [id])
  
  professionalId String
  professional   Professional      @relation(fields: [professionalId], references: [id])
  
  serviceId      String?
  service        Service?          @relation(fields: [serviceId], references: [id])

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([date])
  @@index([userId])
  @@index([professionalId])
}

model Availability {
  id             String       @id @default(cuid())
  dayOfWeek      Int          // 0=Domingo, 1=Lunes...
  startTime      String       // "09:00"
  endTime        String       // "13:00"
  
  professionalId String
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  // ⚠️ IMPORTANTE: Elimina la línea @@unique o cámbiala por @@index
  @@index([professionalId, dayOfWeek]) 
}


// --------------------------------------------------------
// CONTENIDO: BLOG
// --------------------------------------------------------

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Post {
  id          String     @id @default(cuid())
  title       String
  slug        String     @unique
  content     String     @db.Text
  excerpt     String?    @db.Text
  coverImage  String?
  status      PostStatus @default(DRAFT)
  
  // SEO
  metaTitle   String?
  metaDesc    String?

  authorId    String
  author      Professional @relation(fields: [authorId], references: [id])

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// --------------------------------------------------------
// AUTH.JS (NEXT-AUTH) - Tablas requeridas si usas adapters
// --------------------------------------------------------

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}