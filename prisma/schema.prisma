// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --------------------
// ENUMS
// --------------------

enum Role {
  USER
  PROFESSIONAL
  ADMIN
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED_BY_USER
  CANCELLED_BY_PRO
  NO_SHOW
}

enum ServiceAssignmentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PostStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  REJECTED
}

// --------------------
// MODELS
// --------------------

model User {
  id    String @id @default(cuid())
  name  String
  email String @unique

  phone          String? @db.VarChar(32)
  identification String? @db.VarChar(32) // ✅ agregado (cédula/DNI/etc.)

  birthDate DateTime?
  gender    String?
  interests String?

  passwordHash String?
  image        String?

  role Role @default(USER)

  emailVerified DateTime?
  isActive      Boolean  @default(true)
  lastLogin     DateTime?

  acquisitionChannel String?
  campaignName       String?

  verifyTokenHash String?
  verifyTokenExp  DateTime?
  resetTokenHash  String?
  resetTokenExp   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  professionalProfile ProfessionalProfile?
  appointments        Appointment[]
  postViewEvents      PostViewEvent[]

  @@index([role])
  @@index([identification])
}

model ProfessionalProfile {
  id     String @id @default(cuid())
  userId String @unique

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  specialty String?
  bio       String?

  // Aprobación / visibilidad
  isApproved Boolean @default(false)
  approvedAt DateTime?
  rejectedAt DateTime?
  rejectionReason String?

  // Integraciones (Google Calendar, etc.)
  calendarUrl        String?
  googleRefreshToken String?
  googleCalendarId   String?
  googleConnectedAt  DateTime?

  // Pagos (link base para crear links por cita/servicio)
  paymentLinkBase String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  services     ServiceAssignment[]
  availability Availability[]
  appointments Appointment[]
  posts        Post[]
}

model Service {
  id          String  @id @default(cuid())
  title       String
  description String?

  durationMin Int

  // Precio (Postgres numeric)
  price    Decimal @db.Numeric(10, 2)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  professionals ServiceAssignment[]
  appointments  Appointment[]

  @@index([isActive])
  @@index([title])
}

model ServiceAssignment {
  professionalId String
  serviceId      String

  status ServiceAssignmentStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  professional ProfessionalProfile @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  service      Service             @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([professionalId, serviceId]) // usado por: professionalId_serviceId
  @@index([serviceId])
  @@index([professionalId])
  @@index([status])
}

model Availability {
  id             String @id @default(cuid())
  professionalId String

  // 0=Domingo ... 6=Sábado (o tu convención)
  dayOfWeek Int

  // "HH:MM" (simple y ordenable)
  startTime String @db.VarChar(5)
  endTime   String @db.VarChar(5)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  professional ProfessionalProfile @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@index([professionalId])
  @@index([dayOfWeek])
  @@index([isActive])
}

model Appointment {
  id String @id @default(cuid())

  userId         String
  professionalId String
  serviceId      String

  date    DateTime
  endDate DateTime

  status AppointmentStatus @default(PENDING)

  notes        String?
  cancelReason String?
  cancelledAt  DateTime?

  // Para idempotencia con Google Calendar
  googleEventId    String?
  googleCalendarId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  professional ProfessionalProfile @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  service      Service            @relation(fields: [serviceId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([professionalId])
  @@index([serviceId])
  @@index([status])
  @@index([date])
}

model Post {
  id      String @id @default(cuid())
  title   String
  slug    String @unique
  excerpt String?
  content String

  status PostStatus @default(DRAFT)

  publishedAt DateTime?

  authorId String
  author   ProfessionalProfile @relation(fields: [authorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  postViewEvents PostViewEvent[]

  @@index([status])
  @@index([authorId])
  @@index([publishedAt])
}

model PostViewEvent {
  id String @id @default(cuid())

  postId String
  userId String?

  // opcional: trazabilidad light
  ipHash    String?
  userAgent String?

  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([postId])
  @@index([userId])
  @@index([createdAt])
}
